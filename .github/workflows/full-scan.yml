name: Full Nightly Pentest CI

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"    # runs every day at midnight UTC

jobs:
  run-if-pr-exists:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Fail if no PRs
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
            });

            if (prs.data.length === 0) {
              core.setFailed("No PRs found. Workflow failed.");
            }


  build-and-test:
    runs-on: ubuntu-latest
    # needs: run-if-pr-exists

    steps:
    # ===============================
    # Checkout & Setup
    # ===============================
    - name: Checkout repo
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: "24"

    # ===============================
    # CodeQL (SAST)
    # ===============================
   # - name: Initialize CodeQL
   #  uses: github/codeql-action/init@v4
   #   with:
   #     languages: javascript

    - name: Get Node version
      id: node
      run: |
       echo "version=$(node -v)" >> $GITHUB_OUTPUT
    - name: Cache node_modules
      uses: actions/cache@v3
      with:
        path: |
            ~/.npm
            **/node_modules
        key: ${{ runner.os }}-node-${{ steps.node.outputs.version }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    - name: Install dependencies
      run: npm install

#    - name: Perform CodeQL Analysis
 #     uses: github/codeql-action/analyze@v4

    # ===============================
    # Supply-Chain Security
    # ===============================

    #- name: npm Audit
    #  run: npm audit --audit-level=high || true # continue the scan even if high or critical alerts were found

    #- name: Secrets Scan â€” Gitleaks
    #  uses: gitleaks/gitleaks-action@v2.3.4

    # ===============================
    # Start & Test Application
    # ===============================
    - name: Start Juice Shop
      run: |
        nohup npm start > juice-shop.log 2>&1 & disown

    - name: Wait for server
      run: npx wait-on http://localhost:3000 --timeout 120000

    - name: Smoke test
      run: curl -fI http://localhost:3000
    # ===============================
    # DAST (ZAP / Nikto / Nuclei)
    # ===============================
    
    # ===============================
    # Nuclei
    # ===============================

    - name: Run Nuclei Scan
      uses: projectdiscovery/nuclei-action@main
      with:
        target: http://localhost:3000
        output: nuclei_report.json
        
    - name: Cache Nuclei Templates
      uses: actions/cache@v5
      with:
        path: ~/.nuclei
        key: ${{ runner.os }}-nuclei-templates
        

    - name: Upload Nuclei Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: nuclei-scan
        path: nuclei_report.json

     
    # ===============================
    # ZAP Full scan
    # ===============================
    

       #-------Summary in Run-------# 
  

          
