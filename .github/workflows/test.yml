name: Automated Pentest CI V2

on:
  workflow_dispatch:

jobs:
  CodeQL--npm_audit:
    runs-on: ubuntu-latest

    steps:
    # ===============================
    # Checkout & Setup
    # ===============================
    - name: Checkout repo
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: "24"

    # ===============================
    # CodeQL (SAST)
    # ===============================
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: javascript

    - name: Get Node version
      id: node
      run: |
        echo "version=$(node -v)" >> $GITHUB_OUTPUT

    - name: Cache node_modules
      uses: actions/cache@v3
      with:
        path: |
            ~/.npm
            **/node_modules
        key: ${{ runner.os }}-node-${{ steps.node.outputs.version }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install dependencies
      run: npm install

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4

    # ===============================
    # Supply-Chain Security
    # ===============================

    - name: npm Audit
      run: npm audit --audit-level=high || true # continue the scan even if high or critical alerts were found

    #- name: Secrets Scan â€” Gitleaks
    #  uses: gitleaks/gitleaks-action@v2.3.4
  Zap-scan:
    runs-on: ubuntu-latest

    steps:
    # ===============================
    # Checkout & Setup
    # ===============================
    - name: Checkout repo
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: "24"

    - name: Get Node version
      id: node
      run: |
        echo "version=$(node -v)" >> $GITHUB_OUTPUT

    - name: Cache node_modules
      uses: actions/cache@v3
      with:
        path: |
            ~/.npm
            **/node_modules
        key: ${{ runner.os }}-node-${{ steps.node.outputs.version }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
        
    - name: Install dependencies
      run: npm install

    # ===============================
    # Start & Test Application
    # ===============================
    - name: Start Juice Shop
      run: |
        nohup npm start > juice-shop.log 2>&1 & disown

    - name: Wait for server
      run: npx wait-on http://localhost:3000 --timeout 120000

    - name: Smoke test
      run: curl -fI http://localhost:3000
    # ===============================
    # DAST ZAP Baseline
    # ===============================
    
    - name: run ZAP baseline scan
      uses: zaproxy/action-baseline@v0.15.0
      with:
          target: "http://localhost:3000"
          fail_action: false
          cmd_options: >
            -a
            -j
            -J zap_report.json     
            
    - name: Upload ZAP Baseline Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
          name: zap-baseline-scan
          path: |
            zap_report.json
            zap_report.html
            
     #-------Summary in Run-------# 
    - name: ZAP Alert Summary
      run: | 
         echo "##  OWASP ZAP Baseline Scan Summary" >> $GITHUB_STEP_SUMMARY
         HIGH=$(jq '[.site[].alerts[] | select(.riskcode == "3")] | length' zap_report.json)
         MEDIUM=$(jq '[.site[].alerts[] | select(.riskcode == "2")] | length' zap_report.json)
         LOW=$(jq '[.site[].alerts[] | select(.riskcode == "1")] | length' zap_report.json)
         INFO=$(jq '[.site[].alerts[] | select(.riskcode == "0")] | length' zap_report.json)
         
         echo "|  Severity | Count |" >> $GITHUB_STEP_SUMMARY
         echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
         echo "| ðŸ”´ High   | $HIGH |" >> $GITHUB_STEP_SUMMARY
         echo "| ðŸŸ  Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
         echo "| ðŸŸ¡ Low    | $LOW |" >> $GITHUB_STEP_SUMMARY
         echo "| ðŸ”µ Info   | $INFO |" >> $GITHUB_STEP_SUMMARY
          
